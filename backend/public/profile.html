<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Profile</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>

<body>
<div class="container mt-5" style="max-width:500px;">
  <h3 class="mb-4">Your Profile</h3>

  <form id="updateForm">
    <div class="mb-3">
      <label>Username</label>
      <input type="text" id="username" class="form-control" required>
    </div>

    <div class="mb-3">
      <label>Email</label>
      <input type="email" id="email" class="form-control" disabled>
    </div>

    <div class="mb-3">
      <label>New Password (optional)</label>
      <input type="password" id="password" class="form-control">
    </div>

    <button type="submit" class="btn btn-primary w-100">
      Update Profile
    </button>
  </form>

  <hr>

  <button id="deleteBtn" class="btn btn-danger w-100 mt-3">
    Delete Account
  </button>

  <button id="logoutBtn" class="btn btn-secondary w-100 mt-2">
    Logout
  </button>
</div>

<script>
const token = localStorage.getItem("token");

if(!token){
  alert("Please login first");
  window.location.href = "/login.html";
}

// ✅ Load user profile on page load
async function loadProfile() {
  try {
    const res = await fetch("/api/auth/me", {
      method: "GET",
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    const data = await res.json();

    if(!res.ok){
      throw new Error(data.message || "Session expired");
    }

    document.getElementById("username").value = data.user.username;
    document.getElementById("email").value = data.user.email;

  } catch (err){
    alert(err.message);
    localStorage.removeItem("token");
    window.location.href = "/login.html";
  }
}

loadProfile();


// ✅ Update profile
document.getElementById("updateForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;

  const body = { username };
  if(password) body.password = password;

  const res = await fetch("/api/auth/me", {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify(body)
  });

  const data = await res.json();

  if(res.ok){
    if(data.token){
      localStorage.setItem("token", data.token);
    }
    alert("Profile updated successfully");
    document.getElementById("password").value = "";
  } else {
    alert(data.message);
  }
});


// ✅ Delete account
document.getElementById("deleteBtn").addEventListener("click", async ()=>{
  if(!confirm("Are you sure you want to delete your account permanently?")) return;

  const res = await fetch("/api/auth/me", {
    method: "DELETE",
    headers: {
      "Authorization": "Bearer " + token
    }
  });

  const data = await res.json();

  alert(data.message);
  localStorage.removeItem("token");
  window.location.href = "/login.html";
});


// ✅ Logout
document.getElementById("logoutBtn").addEventListener("click", ()=>{
  localStorage.removeItem("token");
  window.location.href = "/login.html";
});
</script>
</body>
</html>
